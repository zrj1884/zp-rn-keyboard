//@flow

import React, { Component } from 'react';

import PropTypes from 'prop-types'

import {
    TouchableOpacity,
    Text,
    Image,
    View,
    StyleSheet,
    findNodeHandle,
    DeviceInfo,
    Dimensions,
} from 'react-native';

//提示
import { KeyTip } from './views'
const { width } = Dimensions.get("window");

export default class KeyBoard extends Component {
    state: Object
    showHeader: boolean
    backSpaceRequest: number
    insertTextRequest: number
    clearFocusRequest: number
    clearAllRequest: number

    static propTypes = {
        showHeader: PropTypes.bool,
        insertText: PropTypes.func.isRequired,
        clearFocus: PropTypes.func.isRequired,
        clearAll: PropTypes.func.isRequired,
        KeyBoardView: PropTypes.any.isRequired,
    }

    static getDerivedStateFromProps(nextProps, prevState) {
        if (nextProps.showHeader !== prevState.showHeader) {
            return ({
                showHeader: nextProps.showHeader
            });
        }
        return null;
    }

    constructor() {
        super(...arguments)
        this.state = {
            showHeader: this.props.showHeader,
            width: width,
            showTip: { isShow: false, layout: { x: 0, y: 0, width: 0, height: 0 }, keyValue: "" }
        }
    }

    _handleDelete = () => {
        // this.backSpaceRequest && cancelAnimationFrame(this.backSpaceRequest)
        // this.backSpaceRequest = requestAnimationFrame(() => {
        this.props.backSpace(this.props.tag);
        // })
    };

    _handleKeyPress = (key) => {
        // this.insertTextRequest && cancelAnimationFrame(this.insertTextRequest)
        // this.insertTextRequest = requestAnimationFrame(() => {
        this.props.insertText(this.props.tag, key);
        // })
    }

    _clearFocus = () => {
        this.clearFocusRequest && cancelAnimationFrame(this.clearFocusRequest)
        this.clearFocusRequest = requestAnimationFrame(() => {
            this.props.clearFocus(this.props.tag)
        })
    }

    _handlerClearAll = () => {
        this.clearAllRequest && cancelAnimationFrame(this.clearAllRequest)
        this.clearAllRequest = requestAnimationFrame(() => {
            this.props.clearAll(this.props.tag)
        })
    }

    //{isShow, ref, keyValue}
    _showTip = (showTipData) => {
        if (showTipData.isShow) {
            showTipData.ref.measureLayout(findNodeHandle(this.refs.keyboard), (left, top, width, height) => {
                console.log(`key: ${showTipData.keyValue} left:${left} top:${top} width:${width} height:${height}`)
                //{isShow:false, layout:{x:0,y:0,width:0,height:0}, keyValue:""}
                this.setState({ ...this.state, showTip: { ...showTipData, layout: { x: left, y: top, width, height } } })
            })
        } else {
            this.setState({ ...this.state, showTip: showTipData })
        }
    }

    _onLayout = ({ nativeEvent }) => {
        const width = nativeEvent.layout.width
        let height = nativeEvent.layout.height
        if (width > 0 && width !== this.state.width) {
            this.setState({ ...this.state, width })
        }
    }

    _renderTip = () => {
        const { isShow, layout, keyValue } = this.state.showTip
        return isShow ?
            (
                <KeyTip
                    layout={layout}
                    keyValue={keyValue}
                />
            )
            :
            null
    }

    componentWillUnmount() {
        this.clearFocusRequest && cancelAnimationFrame(this.clearFocusRequest)
        this.insertTextRequest && cancelAnimationFrame(this.insertTextRequest)
        this.backSpaceRequest && cancelAnimationFrame(this.backSpaceRequest)
        this.clearAllRequest && cancelAnimationFrame(this.clearAllRequest)
    }

    render() {
        const { KeyBoardView, showHeader, ...reset } = this.props

        let keyBoardHeight = DeviceInfo.isIPhoneX_deprecated ? 286 : 252;
        if (!showHeader) {
            keyBoardHeight -= 36;
        }
        return (
            <View onLayout={this._onLayout} style={[styles.container]} ref="keyboard" pointerEvents="box-none">
                <View style={[styles.keyBoard, { width, height: keyBoardHeight }]} key="keyboard">
                    {
                        (showHeader) && (
                            <View style={styles.top}>
                                <View style={styles.topLeft}>
                                    {
                                        KeyBoardView.getKeyBoardIcon && KeyBoardView.getKeyBoardIcon()
                                    }
                                    <Text style={styles.topDesText}>{KeyBoardView.getKeyBoardName && KeyBoardView.getKeyBoardName()}</Text>
                                </View>
                                <TouchableOpacity onPress={this._clearFocus}>
                                    <Text style={styles.topCompleteText}>完成</Text>
                                </TouchableOpacity>
                            </View>
                        )
                    }
                    <KeyBoardView
                        {...reset}
                        onKeyPress={this._handleKeyPress}
                        onDelete={this._handleDelete}
                        onClearAll={this._handlerClearAll}
                        showTip={this._showTip}
                    />
                </View>
                {this._renderTip()}
            </View>
        )
    }
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: 'transparent',
        justifyContent: 'flex-end',
        alignItems: 'flex-end',
    },
    keyBoard: {
        backgroundColor: '#f6f5f2',
        height: DeviceInfo.isIPhoneX_deprecated ? 286 : 252,
    },
    top: {
        height: 36,
        borderTopWidth: StyleSheet.hairlineWidth,
        borderTopColor: '#a5a5a5',
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
    },
    topLeft: {
        paddingLeft: 15,
        flexDirection: 'row',
    },
    topDesText: {
        color: '#adadad',
        fontSize: 15,
        paddingHorizontal: 8,
    },
    topCompleteText: {
        color: '#0297fa',
        fontSize: 15,
        paddingHorizontal: 15,
        paddingVertical: 10,
    }
})

